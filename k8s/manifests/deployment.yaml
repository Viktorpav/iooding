apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-pvc
  namespace: iooding
  labels:
    app: iooding-blog
    recurring-job-group.longhorn.io/backup: enabled
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn-storage
  resources:
    requests:
      storage: 1Gi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: iooding-migration
  namespace: iooding
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  template:
    spec:
      nodeSelector: { "node-role.kubernetes.io/storage": "true" }
      restartPolicy: OnFailure
      containers:
        - name: migrate
          image: viktor2003/iooding:v43
          command: ["sh", "-c", "/app/docker-entrypoint.sh deploy"]
          env:
            - name: DJANGO_SUPERUSER_USERNAME
              valueFrom: { secretKeyRef: { name: iooding-admin-secret, key: username } }
            - name: DJANGO_SUPERUSER_PASSWORD
              valueFrom: { secretKeyRef: { name: iooding-admin-secret, key: password } }
            - name: DB_PASSWORD
              valueFrom: { secretKeyRef: { name: postgres-secret, key: password } }
            - name: DB_HOST
              value: postgres
            - name: DJANGO_SECRET_KEY
              valueFrom: { secretKeyRef: { name: postgres-secret, key: django_secret_key } }
          resources:
            requests: { cpu: 50m, memory: 256Mi }
            limits: { cpu: 500m, memory: 512Mi }

---
apiVersion: v1
kind: Service
metadata:
  name: iooding-service
  namespace: iooding
spec:
  selector: { app: iooding-blog }
  ports: [{ port: 80, targetPort: 8000 }]

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iooding-blog
  namespace: iooding
spec:
  replicas: 1
  strategy: { type: Recreate }
  selector:
    matchLabels: { app: iooding-blog }
  template:
    metadata:
      labels: { app: iooding-blog }
    spec:
      nodeSelector: { "node-role.kubernetes.io/storage": "true" }
      terminationGracePeriodSeconds: 10
      tolerations:
        - { key: "node.kubernetes.io/not-ready", operator: "Exists", effect: "NoExecute", tolerationSeconds: 10 }
        - { key: "node.kubernetes.io/unreachable", operator: "Exists", effect: "NoExecute", tolerationSeconds: 10 }
      securityContext: { runAsNonRoot: true, runAsUser: 100, fsGroup: 100 }
      initContainers:
        - name: wait-for-db
          image: alpine:latest
          command: ["sh", "-c", "until nc -z postgres 5432; do sleep 1; done"]
      containers:
        - name: iooding
          image: viktor2003/iooding:v43
          ports: [{ containerPort: 8000 }]
          env:
            - name: DB_PASSWORD
              valueFrom: { secretKeyRef: { name: postgres-secret, key: password } }
            - name: DB_HOST
              value: postgres
            - name: REDIS_URL
              value: redis://redis:6379/1
            - name: ALLOWED_HOSTS
              value: "*"
            - name: DEBUG
              value: "True"
            - name: CSRF_TRUSTED_ORIGINS
              value: "https://iooding.local"
            - name: DJANGO_SECRET_KEY
              valueFrom: { secretKeyRef: { name: postgres-secret, key: django_secret_key } }
          volumeMounts:
            - { name: media-storage, mountPath: /app/media }
            - { name: tmp-volume, mountPath: /tmp }
          startupProbe:
            httpGet: { path: /health/, port: 8000 }
            failureThreshold: 30
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/, port: 8000 }
            periodSeconds: 10
          readinessProbe:
            httpGet: { path: /health/, port: 8000 }
            periodSeconds: 5
      volumes:
        - name: media-storage
          persistentVolumeClaim: { claimName: media-pvc }
        - name: tmp-volume
          emptyDir: { medium: Memory, sizeLimit: 128Mi }
