{% extends "base.html" %}

{% block title %} | Architecture & Laboratory{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <!-- Hero Section -->
        <header class="text-center mb-5 mt-4">
            <h1 class="display-2 fw-bold mb-3 gradient-text">Architecture Ledger</h1>
            <p class="lead text-muted mx-auto" style="max-width: 900px;">
                A comprehensive analysis of the <strong>Ding Infrastructure</strong>.
                Built on a distributed Kubernetes foundation, optimized for silicon-native AI inference.
            </p>
        </header>

        <!-- Advanced Topology Map -->
        <div class="glass-card p-5 rounded-4 mb-5 border-0 shadow-lg"
            style="background: var(--surface); position: relative; overflow: visible;">
            <div class="mb-5">
                <h3 class="h2 fw-bold mb-1">System Topology</h3>
                <p class="text-muted text-uppercase letter-spacing-2 smallest">Full Cluster Logic Visualization</p>
            </div>

            <div class="topology-wrapper mb-5"
                style="background: rgba(var(--text), 0.02); border-radius: 30px; padding: 40px; border: 1px solid var(--border);">
                <!-- Legend -->
                <div class="d-flex gap-4 mb-4 justify-content-center small opacity-60">
                    <div class="d-flex align-items-center gap-2"><span
                            style="width:12px; height:12px; background:var(--primary); border-radius:3px;"></span> Core
                        Service</div>
                    <div class="d-flex align-items-center gap-2"><span
                            style="width:12px; height:2px; border-bottom:2px dashed var(--primary);"></span> Logical
                        Flow</div>
                    <div class="d-flex align-items-center gap-2"><span
                            style="width:12px; height:12px; background:#10b981; border-radius:50%;"></span> Master Node
                    </div>
                </div>

                <div class="svg-container" style="position: relative;">
                    <svg id="main-topology" viewBox="0 0 1000 500" class="w-100 h-auto">
                        <defs>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur" />
                                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                            </filter>
                        </defs>

                        <!-- Layers -->
                        <!-- 1. Infrastructure (Base) -->
                        <g class="infra-layer">
                            <!-- Master -->
                            <rect x="50" y="200" width="120" height="100" rx="15" class="topo-node"
                                data-title="Mac-Master-01"
                                data-desc="Control plane node running ETCD and API Server. Optimized for Silicon performance." />
                            <text x="110" y="255" text-anchor="middle" class="node-label">MASTER</text>

                            <!-- Worker 1 -->
                            <rect x="250" y="100" width="120" height="100" rx="15" class="topo-node"
                                data-title="Worker-01 (Inference)"
                                data-desc="Dedicated silicon worker for AI workloads and Ollama inference models." />
                            <text x="310" y="155" text-anchor="middle" class="node-label">WORKER 01</text>

                            <!-- Worker 2 -->
                            <rect x="250" y="300" width="120" height="100" rx="15" class="topo-node"
                                data-title="Worker-02 (Storage)"
                                data-desc="Storage-optimized worker hosting the Longhorn replicated volumes and Databases." />
                            <text x="310" y="355" text-anchor="middle" class="node-label">WORKER 02</text>
                        </g>

                        <!-- 2. Networking (Connectors) -->
                        <g class="network-layer" stroke="var(--primary)" stroke-width="1.5" fill="none">
                            <path d="M170,250 L250,150" class="flow-path" />
                            <path d="M170,250 L250,350" class="flow-path" />

                            <!-- External Traffic -->
                            <path d="M0,250 Q100,250 170,250" stroke-dasharray="5,5" class="flow-path animated" />
                        </g>

                        <!-- 3. Service Mesh -->
                        <g class="service-layer">
                            <!-- MetalLB -->
                            <circle cx="210" cy="250" r="25" class="topo-service" data-title="MetalLB"
                                data-desc="BGP-based Load Balancer providing internal IP allocation for the cluster." />
                            <text x="210" y="254" text-anchor="middle" font-size="8" fill="white">LB</text>

                            <!-- Calico -->
                            <rect x="180" y="100" width="60" height="30" rx="5" class="topo-node-alt"
                                data-title="Calico CNI"
                                data-desc="High-performance container networking with BGP routing and network policies." />
                            <text x="210" y="120" text-anchor="middle" font-size="6" fill="var(--primary)">CNI</text>

                            <!-- ArgoCD -->
                            <rect x="50" y="50" width="80" height="40" rx="10" class="topo-service" data-title="ArgoCD"
                                data-desc="The GitOps brain. Synchronizes GitHub manifests with the physical cluster state." />
                            <text x="90" y="75" text-anchor="middle" font-size="8" fill="white">GITOPS</text>

                            <!-- Ingress -->
                            <rect x="420" y="200" width="100" height="100" rx="20" class="topo-node-primary"
                                data-title="Nginx Ingress"
                                data-desc="The main traffic gateway handles SSL termination and Route53 DNS synchronization." />
                            <text x="470" y="255" text-anchor="middle" class="node-label" fill="white">INGRESS</text>

                            <!-- Cert Manager -->
                            <rect x="430" y="80" width="80" height="40" rx="8" class="topo-node-alt"
                                data-title="Cert-Manager"
                                data-desc="Automated TLS certificate management using Let's Encrypt and custom CA." />
                            <text x="470" y="105" text-anchor="middle" font-size="7" fill="var(--primary)">TLS
                                SYNC</text>

                            <!-- Longhorn -->
                            <rect x="430" y="380" width="80" height="40" rx="8" class="topo-node-alt"
                                data-title="Longhorn Storage"
                                data-desc="High-availability block storage with distributed replication across worker nodes." />
                            <text x="470" y="405" text-anchor="middle" font-size="7"
                                fill="var(--primary)">STORAGE</text>
                        </g>

                        <!-- 4. Application Stack -->
                        <g class="app-layer">
                            <rect x="650" y="180" width="140" height="140" rx="25" class="topo-app"
                                data-title="iooding-blog"
                                data-desc="The Django 5.1 core application running in high-availability mode." />
                            <text x="720" y="245" text-anchor="middle" class="node-label">APP CORE</text>

                            <!-- AI Hub -->
                            <circle cx="720" cy="120" r="35" class="topo-service-ai" data-title="Ollama"
                                data-desc="Local AI inference hub serving Qwen and Llama models via internal API." />
                            <text x="720" y="124" text-anchor="middle" font-size="8" fill="white">AI</text>

                            <!-- Redis -->
                            <circle cx="850" cy="250" r="30" class="topo-service" data-title="Redis Stack"
                                data-desc="Vector database and caching layer for sub-100ms retrieval." />
                            <text x="850" y="254" text-anchor="middle" font-size="8" fill="white">REDIS</text>
                        </g>
                    </svg>

                    <!-- Tooltip Box -->
                    <div id="topo-tooltip" class="topo-tooltip">
                        <h5 id="topo-tool-title"></h5>
                        <p id="topo-tool-desc"></p>
                    </div>
                </div>
            </div>

            <!-- Detailed Specs Grid -->
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="p-4 rounded-4 bg-primary bg-opacity-5 h-100 border border-primary border-opacity-10">
                        <i class="mb-3 d-block text-primary">01</i>
                        <h6 class="fw-bold">GitOps Flow</h6>
                        <p class="smallest text-muted mb-0">Declarative deployments via ArgoCD ensure the cluster stays
                            in its desired state automatically.</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-4 rounded-4 bg-primary bg-opacity-5 h-100 border border-primary border-opacity-10">
                        <i class="mb-3 d-block text-primary">02</i>
                        <h6 class="fw-bold">Silicon Native</h6>
                        <p class="smallest text-muted mb-0">M-series optimization reduces inference latency by 40%
                            compared to traditional cloud CPU rigs.</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-4 rounded-4 bg-primary bg-opacity-5 h-100 border border-primary border-opacity-10">
                        <i class="mb-3 d-block text-primary">03</i>
                        <h6 class="fw-bold">Encryption Edge</h6>
                        <p class="smallest text-muted mb-0">Automated TLS management by Cert-Manager secures every
                            internal and external endpoint.</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-4 rounded-4 bg-primary bg-opacity-5 h-100 border border-primary border-opacity-10">
                        <i class="mb-3 d-block text-primary">04</i>
                        <h6 class="fw-bold">Self-Healing</h6>
                        <p class="smallest text-muted mb-0">Kubernetes health probes automatically restart failed
                            containers within 10 seconds of detection.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chaos Engineer Game -->
        <div class="glass-card mb-5 p-5 rounded-4 border-0 shadow-lg text-white"
            style="background: #0f172a; overflow: hidden;">
            <div class="row align-items-center mb-5">
                <div class="col-md-7">
                    <span class="badge bg-danger px-3 py-2 mb-3">SIMULATION: CHAOS ENGINEER</span>
                    <h2 class="fw-bold mb-3">Defend the Infrastructure</h2>
                    <p class="opacity-70 lead mb-0">A massive traffic spike and storage failures are hitting the
                        cluster. Manual intervention required!</p>
                </div>
                <div class="col-md-5 text-end">
                    <div
                        class="game-scoreboard p-3 rounded-4 bg-white bg-opacity-5 border border-white border-opacity-10">
                        <div class="row g-0">
                            <div class="col-4 text-center border-end">
                                <div class="smallest opacity-50 mb-1">UPTIME</div>
                                <div id="game-v2-time" class="h4 mb-0 fw-bold">0s</div>
                            </div>
                            <div class="col-4 text-center border-end">
                                <div class="smallest opacity-50 mb-1">PODS</div>
                                <div id="game-v2-pods" class="h4 mb-0 fw-bold">0</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="smallest opacity-50 mb-1">CPU LOAD</div>
                                <div id="game-v2-load" class="h4 mb-0 fw-bold text-success">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chaos-game-container" class="position-relative rounded-4"
                style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); min-height: 450px;">
                <div id="game-start-screen"
                    class="position-absolute top-50 start-50 translate-middle text-center w-100 p-4">
                    <div class="mb-4 display-5">‚ö°Ô∏è</div>
                    <button id="start-chaos-btn"
                        class="btn btn-primary btn-lg px-5 py-3 fw-bold rounded-pill">INITIALIZE CLUSTER</button>
                    <p class="mt-3 smallest opacity-40">GOAL: Don't let the CPU Load reach 100%.</p>
                </div>

                <!-- Game Grid -->
                <div id="chaos-grid" class="d-none p-5 row row-cols-4 g-4 h-100 align-content-center">
                    <!-- Pods will spawn here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .topo-node {
        fill: var(--bg);
        stroke: var(--border);
        stroke-width: 2;
        transition: 0.3s;
        cursor: help;
    }

    .topo-node:hover {
        stroke: var(--primary);
        fill: rgba(var(--primary-rgb), 0.05);
        filter: url(#glow);
    }

    .topo-node-primary {
        fill: var(--primary);
        transition: 0.3s;
        cursor: help;
    }

    .topo-node-primary:hover {
        filter: contrast(1.2) brightness(1.1);
    }

    .topo-node-alt {
        fill: transparent;
        stroke: var(--primary);
        stroke-width: 1.5;
        stroke-dasharray: 2, 2;
        cursor: help;
    }

    .topo-app {
        fill: var(--bg);
        stroke: var(--primary);
        stroke-width: 3;
        cursor: help;
    }

    .topo-service {
        fill: #1e293b;
        stroke: #334155;
        stroke-width: 2;
        cursor: help;
    }

    .topo-service-ai {
        fill: #6366f1;
        stroke: #818cf8;
        stroke-width: 2;
        cursor: help;
    }

    .node-label {
        font-size: 10px;
        font-weight: 700;
        fill: var(--text);
        pointer-events: none;
    }

    .topo-tooltip {
        position: absolute;
        display: none;
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        width: 220px;
        z-index: 100;
        pointer-events: none;
    }

    .topo-tooltip h5 {
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--primary);
    }

    .topo-tooltip p {
        font-size: 0.75rem;
        margin-bottom: 0;
        opacity: 0.7;
    }

    .flow-path.animated {
        stroke-dasharray: 5, 5;
        animation: flowDash 2s linear infinite;
    }

    @keyframes flowDash {
        to {
            stroke-dashoffset: -20;
        }
    }

    /* Game v2 Styles */
    .chaos-pod {
        height: 80px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .chaos-pod:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .chaos-pod.failed {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        animation: shake 0.5s infinite;
    }

    .chaos-pod.failed::after {
        content: "RESTART";
        position: absolute;
        bottom: 5px;
        font-size: 0.6rem;
        font-weight: bold;
        color: #ef4444;
    }

    .chaos-pod i {
        font-size: 1.2rem;
        margin-bottom: 4px;
    }

    @keyframes shake {
        0% {
            transform: translate(0);
        }

        25% {
            transform: translate(2px);
        }

        50% {
            transform: translate(-2px);
        }

        75% {
            transform: translate(2px);
        }

        100% {
            transform: translate(0);
        }
    }
</style>

<script>
    // Topology Tooltips
    const tooltip = document.getElementById('topo-tooltip');
    const nodes = document.querySelectorAll('.topo-node, .topo-node-primary, .topo-node-alt, .topo-app, .topo-service, .topo-service-ai');

    nodes.forEach(node => {
        node.addEventListener('mouseenter', (e) => {
            const title = node.getAttribute('data-title');
            const desc = node.getAttribute('data-desc');
            document.getElementById('topo-tool-title').innerText = title;
            document.getElementById('topo-tool-desc').innerText = desc;

            tooltip.style.display = 'block';
            updateTooltipPos(e);
        });

        node.addEventListener('mousemove', updateTooltipPos);

        node.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
    });

    function updateTooltipPos(e) {
        const rect = document.querySelector('.svg-container').getBoundingClientRect();
        tooltip.style.left = (e.clientX - rect.left + 20) + 'px';
        tooltip.style.top = (e.clientY - rect.top + 20) + 'px';
    }

    // Chaos Engineer Game v2
    let chaosGameActive = false;
    let chaosUptime = 0;
    let chaosPods = 8;
    let chaosFailed = 0;
    let chaosInterval, chaosTimer;
    const chaosGrid = document.getElementById('chaos-grid');

    document.getElementById('start-chaos-btn').addEventListener('click', startChaosGame);

    function startChaosGame() {
        chaosGameActive = true;
        chaosUptime = 0;
        chaosFailed = 0;
        document.getElementById('game-start-screen').classList.add('d-none');
        chaosGrid.classList.remove('d-none');

        renderPods();

        chaosTimer = setInterval(() => {
            chaosUptime++;
            document.getElementById('game-v2-time').innerText = chaosUptime + 's';

            // Randomly fail pods
            if (Math.random() < 0.2 + (chaosUptime / 100)) {
                triggerPodFailure();
            }

            updateLoad();
        }, 1000);
    }

    function renderPods() {
        chaosGrid.innerHTML = '';
        for (let i = 0; i < 8; i++) {
            const pod = document.createElement('div');
            pod.className = 'col';
            pod.innerHTML = `
            <div class="chaos-pod" id="pod-\${i}" onclick="restartPod(\${i})">
                <i class="opacity-50">üì¶</i>
                <span class="smallest opacity-80">pod-v\${i}</span>
            </div>
        `;
            chaosGrid.appendChild(pod);
        }
        document.getElementById('game-v2-pods').innerText = 8;
    }

    function triggerPodFailure() {
        const livePods = [];
        for (let i = 0; i < 8; i++) {
            const p = document.getElementById(`pod-\${i}`);
            if (!p.classList.contains('failed')) livePods.push(p);
        }

        if (livePods.length > 0) {
            const target = livePods[Math.floor(Math.random() * livePods.length)];
            target.classList.add('failed');
            target.querySelector('i').innerText = '‚ö†Ô∏è';
            chaosFailed++;
        }
    }

    function restartPod(id) {
        const pod = document.getElementById(`pod-\${id}`);
        if (pod.classList.contains('failed')) {
            pod.classList.remove('failed');
            pod.querySelector('i').innerText = 'üì¶';
            chaosFailed--;
            updateLoad();
        }
    }

    function updateLoad() {
        const load = Math.round((chaosFailed / 8) * 100);
        const loadEl = document.getElementById('game-v2-load');
        loadEl.innerText = load + '%';

        if (load < 40) loadEl.className = 'h4 mb-0 fw-bold text-success';
        else if (load < 80) loadEl.className = 'h4 mb-0 fw-bold text-warning';
        else loadEl.className = 'h4 mb-0 fw-bold text-danger';

        if (load >= 100) {
            endChaosGame();
        }
    }

    function endChaosGame() {
        chaosGameActive = false;
        clearInterval(chaosTimer);
        chaosGrid.classList.add('d-none');
        const startScreen = document.getElementById('game-start-screen');
        startScreen.classList.remove('d-none');
        startScreen.innerHTML = `
        <h2 class="text-danger fw-bold mb-3">CLUSTER OVERFLOW</h2>
        <p class="mb-4 lead">Uptime: \${chaosUptime} seconds. Infrastructure collapsed under load.</p>
        <button onclick="location.reload()" class="btn btn-outline-light px-5 py-3 rounded-pill fw-bold">RETRY ARCHITECTURE</button>
    `;
    }
</script>
{% endblock %}