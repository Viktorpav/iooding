{% extends "base.html" %}

{% block title %} | Physical Privacy & Audit{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <header class="text-center mb-5 mt-4">
            <h1 class="display-4 fw-bold mb-3 gradient-text">Security Ledger</h1>
            <p class="text-muted lead">Zero-Trust Physical Infrastructure & Privacy Protocols</p>
        </header>

        <!-- Advanced Privacy Terminal -->
        <div class="terminal-shell mb-5 shadow-2xl rounded-4 overflow-hidden border border-white border-opacity-10"
            style="background: #0a0c10;">
            <div class="terminal-header d-flex align-items-center justify-content-between px-4 py-2"
                style="background: #161b22;">
                <div class="d-flex gap-2">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f56;"></span>
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></span>
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #27c93f;"></span>
                </div>
                <div class="terminal-title smallest fw-bold opacity-40 text-uppercase letter-spacing-2">Cluster Audit
                    Protocol v4.2</div>
                <div class="smallest opacity-20">SSH: SECURE</div>
            </div>

            <div id="advanced-terminal" class="p-4"
                style="height: 500px; font-family: 'JetBrains Mono', monospace; overflow-y: auto;">
                <div class="text-primary mb-1">Connecting to laboratory-control-plane...</div>
                <div class="text-success mb-3">CONNECTION ESTABLISHED via Mutual TLS</div>
                <div class="text-muted mb-4 small">
                    * Laboratory Privacy Shield: ENABLED<br>
                    * Global Egress Filtering: ACTIVE<br>
                    * Local Inference Routing: VERIFIED
                </div>
                <div class="mb-4">Type <span class="text-warning">'man audit'</span> to view the security challenge
                    manual.</div>

                <div id="term-output"></div>

                <div class="d-flex align-items-center mt-2">
                    <span class="text-success fw-bold me-2">auditor@nexus:~$</span>
                    <input type="text" id="term-input" class="bg-transparent border-0 text-white w-100 p-0"
                        style="outline: none;" autocomplete="off" autofocus spellcheck="false">
                </div>
            </div>
        </div>

        <!-- Infrastructure Security Content -->
        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="glass-card p-5 h-100 rounded-4 border-0 shadow-sm" style="background: var(--surface);">
                    <h3 class="h4 fw-bold mb-4 d-flex align-items-center">
                        <span class="me-3 p-2 bg-primary bg-opacity-10 rounded-3 text-primary"
                            style="font-size: 1rem;">üõ°Ô∏è</span>
                        Identity & TLS
                    </h3>
                    <p class="text-muted small">
                        The infrastructure uses a <strong>Multi-Tiered PKI</strong> (Public Key Infrastructure). Every
                        microservice communication is encrypted via <strong>mTLS</strong> (Mutual TLS) managed by
                        Cert-Manager with a private, air-gapped Root CA.
                    </p>
                    <ul class="smallest text-muted opacity-80 ps-3">
                        <li>Automatic rotation of internal certs every 24h.</li>
                        <li>Strict SNI inspection for all ingress traffic.</li>
                        <li>Non-traditional port obfuscation for admin interfaces.</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card p-5 h-100 rounded-4 border-0 shadow-sm" style="background: var(--surface);">
                    <h3 class="h4 fw-bold mb-4 d-flex align-items-center">
                        <span class="me-3 p-2 bg-primary bg-opacity-10 rounded-3 text-primary"
                            style="font-size: 1rem;">üßä</span>
                        Data Sovereignty
                    </h3>
                    <p class="text-muted small">
                        Unlike traditional cloud deployments, your interactions never transit through public AI
                        providers.
                        <strong>Longhorn</strong> provides cryptographically isolated block storage, ensuring that even
                        at rest, system metadata remains unreadable to unauthorized node processes.
                    </p>
                    <ul class="smallest text-muted opacity-80 ps-3">
                        <li>Cross-node replication for data durability.</li>
                        <li>Session-bound AI memory with instant purging.</li>
                        <li>No telemetry collection or external pings.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .terminal-shell {
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5), 0 18px 36px -18px rgba(0, 0, 0, 0.5);
    }

    #advanced-terminal {
        background: radial-gradient(circle at 10% 10%, #1a1f26 0%, #0a0c10 100%);
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
    }

    #advanced-terminal::-webkit-scrollbar {
        width: 6px;
    }

    #advanced-terminal::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .term-cmd {
        color: #818cf8;
        font-weight: bold;
    }

    .term-res {
        font-size: 0.85rem;
        padding-left: 20px;
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 5px;
    }

    .text-cyan {
        color: #22d3ee;
    }

    .text-gold {
        color: #fbbf24;
    }
</style>

<script>
    const output = document.getElementById('term-output');
    const input = document.getElementById('term-input');
    const terminal = document.getElementById('advanced-terminal');

    let currentLevel = 0;

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const cmd = input.value.trim();
            if (cmd) executeCommand(cmd);
            input.value = '';
            terminal.scrollTop = terminal.scrollHeight;
        }
    });

    function append(text, type = 'default') {
        const div = document.createElement('div');
        div.className = `term-res text-\${type} mb-1`;
        div.innerHTML = text;
        output.appendChild(div);
    }

    function executeCommand(cmd) {
        const line = document.createElement('div');
        line.innerHTML = `<span class="text-success fw-bold">auditor@nexus:~$</span> <span class="term-cmd">\${cmd}</span>`;
        output.appendChild(line);

        const parts = cmd.toLowerCase().split(' ');
        const command = parts[0];
        const args = parts.slice(1);

        switch (command) {
            case 'help':
                append('Core Commands: ls, cat, whoami, clear, man, status');
                append('Advanced: exploit, grep, ssh (requires keys)');
                break;
            case 'man':
                if (args[0] === 'audit') {
                    append('SECURITY AUDIT MANUAL - CHALLENGE ONE', 'cyan');
                    append('1. Scan the server logs for unauthorized access points.');
                    append('2. Localize the internal deployment artifact.');
                    append('3. Escalate privileges to retrieve the Privacy Flag.');
                    append('-- Try: ls logs --', 'muted');
                } else {
                    append('What manual page do you want? (e.g., man audit)');
                }
                break;
            case 'ls':
                if (args[0] === 'logs') {
                    append('auth.log  kernel.log  nginx_access.log', 'success');
                } else if (args[0] === 'secrets' && currentLevel < 1) {
                    append('Permission Denied. Root access required.', 'danger');
                } else if (args[0] === 'secrets' && currentLevel >= 1) {
                    append('privacy_vault.key  system_flag.txt', 'warning');
                } else {
                    append('manifests/  logs/  src/  README.md', 'cyan');
                }
                break;
            case 'grep':
                if (args.includes('auth.log')) {
                    append('20:55:01 Unauthorized SSH attempt from <span class="text-gold">10.0.0.42</span>', 'muted');
                    append('20:55:30 Access granted to root using <span class="text-cyan">local_pki_key</span>', 'muted');
                } else {
                    append('Usage: grep [pattern] [file]');
                }
                break;
            case 'whoami':
                append(currentLevel > 0 ? 'root@nexus (PRIVILEGED)' : 'auditor@nexus (GUEST)');
                break;
            case 'ssh':
                if (args[0] === '10.0.0.42' || args.includes('local_pki_key')) {
                    append('Authenticating with mTLS...', 'cyan');
                    setTimeout(() => {
                        currentLevel = 1;
                        append('SUCCESS: Terminal escalated to ROOT PRIVILEGE.', 'success');
                        append('Try checking \'ls secrets\' now.', 'muted');
                    }, 1000);
                } else {
                    append('Remote host unreachable or invalid key.', 'danger');
                }
                break;
            case 'cat':
                if (args.includes('system_flag.txt') && currentLevel >= 1) {
                    append('DECRYPTING ARCHITECTURE FLAG...', 'cyan');
                    setTimeout(() => {
                        append('FLAG{MTLS_ROOT_SOVEREIGNTY_2026}', 'text-gold fw-bold');
                    }, 800);
                } else if (args.includes('readme.md')) {
                    append('DING PHYSICAL PRIVACY V4<br>This system runs on isolated hardware with no external telemetry.');
                } else {
                    append('File not found or Access Denied.', 'danger');
                }
                break;
            case 'status':
                append('UPTIME: 364 days, 12:44:01', 'success');
                append('SILICON: Apple M3 Max [Active]', 'success');
                append('NETWORK: Air-gapped Mesh Tunnel', 'success');
                break;
            case 'exploit':
                append('NICE TRY. All exploits are logged and blocked by Ingress-Guard.', 'danger');
                break;
            case 'clear':
                output.innerHTML = '';
                break;
            default:
                append(`Command not found: \${command}`, 'danger');
        }
    }
</script>
{% endblock %}